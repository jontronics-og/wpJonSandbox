let audioContext=new(window.AudioContext||window.webkitAudioContext),isPlaying=!1,currentStep=0,intervalId=null,tempo=120,samples={kick:null,snare:null,hihat:null},currentInstrument="kick",patterns={kick:new Array(16).fill(!1),snare:new Array(16).fill(!1),hihat:new Array(16).fill(!1)};async function loadSamples(){if("undefined"==typeof drumSamples)console.log("drumSamples not defined");else{console.log("Available samples:",drumSamples);for(var[t,e]of Object.entries(drumSamples))if(e)try{var n=await(await fetch(e)).arrayBuffer();samples[t]=await audioContext.decodeAudioData(n),console.log(t+" sample loaded successfully")}catch(e){console.error(`Error loading ${t} sample:`,e)}}}let kickBtn=document.getElementById("kick-btn"),snareBtn=document.getElementById("snare-btn"),hihatBtn=document.getElementById("hihat-btn");function selectInstrument(e){switch(kickBtn.style.background="linear-gradient(145deg, #e6e6e6, #d4d4d4)",snareBtn.style.background="linear-gradient(145deg, #e6e6e6, #d4d4d4)",hihatBtn.style.background="linear-gradient(145deg, #e6e6e6, #d4d4d4)",document.getElementById(e+"-btn").style.background="linear-gradient(145deg, #a8d8ff, #87ceeb)",currentInstrument=e){case"kick":playKick();break;case"snare":playSnare();break;case"hihat":playHihat()}updateGridDisplay()}kickBtn.addEventListener("click",()=>selectInstrument("kick")),snareBtn.addEventListener("click",()=>selectInstrument("snare")),hihatBtn.addEventListener("click",()=>selectInstrument("hihat"));let grid=document.getElementById("sequencer-grid"),cells=[];for(let t=0;t<16;t++){let e=document.createElement("button");e.className="cell",e.dataset.step=t,e.addEventListener("click",()=>{patterns[currentInstrument][t]=!patterns[currentInstrument][t],updateGridDisplay()}),grid.appendChild(e),cells.push(e)}function updateGridDisplay(){cells.forEach((e,t)=>{e.classList.toggle("active",patterns[currentInstrument][t])})}function playKick(){if(samples.kick){var t=audioContext.createBufferSource();let e=audioContext.createGain();t.buffer=samples.kick,t.connect(e),e.connect(audioContext.destination),e.gain.setValueAtTime(1,audioContext.currentTime),void t.start()}else{t=audioContext.createOscillator();let e=audioContext.createGain();t.connect(e),e.connect(audioContext.destination),t.frequency.setValueAtTime(150,audioContext.currentTime),t.frequency.exponentialRampToValueAtTime(.01,audioContext.currentTime+.5),e.gain.setValueAtTime(1,audioContext.currentTime),e.gain.exponentialRampToValueAtTime(.01,audioContext.currentTime+.5),t.start(audioContext.currentTime),t.stop(audioContext.currentTime+.5)}}function playSnare(){if(samples.snare)t=audioContext.createBufferSource(),e=audioContext.createGain(),t.buffer=samples.snare,t.connect(e),e.connect(audioContext.destination),e.gain.setValueAtTime(1,audioContext.currentTime),t.start();else{var e=audioContext.createOscillator(),t=audioContext.createGain(),n=(e.type="triangle",e.frequency.setValueAtTime(180,audioContext.currentTime),t.gain.setValueAtTime(.7,audioContext.currentTime),t.gain.exponentialRampToValueAtTime(.01,audioContext.currentTime+.1),e.connect(t),audioContext.createBufferSource()),a=audioContext.createGain(),i=audioContext.createBiquadFilter(),r=.2*audioContext.sampleRate,o=audioContext.createBuffer(1,r,audioContext.sampleRate),u=o.getChannelData(0);for(let e=0;e<r;e++)u[e]=2*Math.random()-1;n.buffer=o,i.type="bandpass",i.frequency.setValueAtTime(3e3,audioContext.currentTime),i.Q.setValueAtTime(5,audioContext.currentTime),a.gain.setValueAtTime(1,audioContext.currentTime),a.gain.exponentialRampToValueAtTime(.01,audioContext.currentTime+.15),n.connect(i),i.connect(a);o=audioContext.createGain();o.gain.setValueAtTime(.8,audioContext.currentTime),t.connect(o),a.connect(o),o.connect(audioContext.destination),e.start(audioContext.currentTime),n.start(audioContext.currentTime),e.stop(audioContext.currentTime+.2),n.stop(audioContext.currentTime+.2)}}function playHihat(){if(samples.hihat){var t=audioContext.createBufferSource();let e=audioContext.createGain();t.buffer=samples.hihat,t.connect(e),e.connect(audioContext.destination),e.gain.setValueAtTime(.3,audioContext.currentTime),void t.start()}else{var n=.1*audioContext.sampleRate,t=audioContext.createBuffer(1,n,audioContext.sampleRate),a=t.getChannelData(0);for(let e=0;e<n;e++)a[e]=2*Math.random()-1;var i=audioContext.createBufferSource(),t=(i.buffer=t,audioContext.createBiquadFilter()),r=(t.type="bandpass",t.frequency.setValueAtTime(1e4,audioContext.currentTime),t.Q.setValueAtTime(8,audioContext.currentTime),audioContext.createBiquadFilter());r.type="highpass",r.frequency.setValueAtTime(7e3,audioContext.currentTime);let e=audioContext.createGain();e.gain.setValueAtTime(.3,audioContext.currentTime),e.gain.exponentialRampToValueAtTime(.01,audioContext.currentTime+.05),i.connect(t),t.connect(r),r.connect(e),e.connect(audioContext.destination),i.start(audioContext.currentTime),i.stop(audioContext.currentTime+.05)}}function step(){cells.forEach(e=>e.classList.remove("playing")),cells[currentStep].classList.add("playing"),patterns.kick[currentStep]&&playKick(),patterns.snare[currentStep]&&playSnare(),patterns.hihat[currentStep]&&playHihat(),currentStep=(currentStep+1)%16}document.getElementById("play-button").addEventListener("click",async()=>{isPlaying||(await loadSamples(),isPlaying=!0,audioContext.resume(),intervalId=setInterval(step,60/tempo*1e3/4))}),document.getElementById("stop-button").addEventListener("click",()=>{isPlaying=!1,clearInterval(intervalId),currentStep=0,cells.forEach(e=>e.classList.remove("playing"))}),document.getElementById("clear-button").addEventListener("click",()=>{patterns[currentInstrument].fill(!1),updateGridDisplay()}),loadSamples();